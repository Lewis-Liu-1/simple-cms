<?php
	require_once("file_parse.php");
	
	class comment_handler extends myfile_parser
	{
		const CSTART ="CMT:";	
		const CSECTION_START ="/";	
		const CSECTION_END ="/";	
		const CSECTION_ESC ="\5"; //CHAR 5	
		const CTIME ="time:";	
		const CIP ="ip:";	
		const CUSER ="username:";	
		const CEMAIL ="email:";	
		const CCMT ="says:";	

		private $filepath;
		private $count;
		private $start;

		private $email;
		private $user;
		private $time;
		private $comment;
		private $ip;
		
		private $vars;
		private $var;
				
		function __construct($s="")
		{
			$this->filepath=$s;
			$this->count=0;
			$this->vars = array(self::CTIME=> 'time',
				self::CIP =>'ip' ,
				self::CUSER =>'user' ,
				self::CEMAIL =>'email' ,
				self::CCMT =>'comment' 
			);
		}
		
		private function R($s)
		{
			return $s=str_replace(" ","&nbsp;",$s);
		}
		
		private function print_me()
		{
				$this->comment =str_replace("\n","<br/>",$this->comment);
				
				echo "<table><tr><td width=30%>\n";
				echo "<span class='shortlink username'>".$this->R($this->user)."</span><br/>\n";
				echo "<span class='shortlink email'>".$this->email."</span><br/>\n";
				echo "<span class='shortlink time'>".$this->R($this->time)."</span><br/>\n";
				echo "<span class='shortlink ip'>".$this->ip."</span><br/>\n";
				echo "</td><td>\n";
				echo "<div class='shortlink says'>".$this->comment."</div>\n";
				echo "</td></tr></table>\n";
		} 
		
		public function get_css_name() 
		{	
			//$this->subsection=false;
			$ret='comment';
			$this->count++;
			if ($this->count % 2 ==0)
			{
				$ret='comment comment1';
			}
			return $ret;
		}
		public function convert_keyword($s)
		{
			$s=$this->get_start($s);
			$s=$this->get_content($s);
			return $s;
		}
		
		function get_start($s)
		{
			$ret=$s;
			$pos = strpos($s,self::CSECTION_START);
			if ($pos!==false)
			{ 
				if ($pos==0)
				{
					if ($this->start)
					{
						$this ->print_me();
						$this->start=false;
					}
					else 
					{
						$this->start=true;
					}
					$this->print = false;
					$ret="";
				}
			}
			return $ret;
		}
	
		function get_content($s)
		{
			$ret=$s;
			$this->print = true;
			
			foreach ($this->vars as $key => $prefix) 
			{
				$pos = strpos($s,$key);
				if ($pos!==false)
				{ 
					if ($pos==0)
					{
						$m=str_replace($key,"",$s);
						$this->var =	&$this->$prefix;
						$this->var = ($m);	
						$this->print = false;
						$ret="";
					}
					break;
				}
			}
			
			if ($this->print)
			{
				$this->print = false;
				if (strlen(trim($s))>0)
			 		$this->var.=($s);	
			}	
			
			return $ret;	
		}
		
		public function add_comment($ho,$cat,$id,$user,$email,$comment)
		{
			$ip=$_SERVER['REMOTE_ADDR'];
	
			$c  =self::CCMT.$comment."\n";
			$c .=self::CTIME.date("D, d M Y H:i:s")."\n";
			$c .=self::CUSER.$user."\n";
			$c .=self::CEMAIL.$email."\n";
			$c .=self::CIP."$ip"."\n";
			
			$file = fopen($this->filepath,"a+") or exit("Unable open file!");
			fputs($file,self::CSTART."\n");
			fputs($file,self::CSECTION_START."\n");
			fputs($file,$ho.":".$cat.":".$id."\n");
			fputs($file,"$c");
			fputs($file,self::CSECTION_END."\n");
			fclose($file); 
			
			return true;
		}
		
		public function read_comment($h,$c,$id)
		{
			
		}
			
	}
?>
